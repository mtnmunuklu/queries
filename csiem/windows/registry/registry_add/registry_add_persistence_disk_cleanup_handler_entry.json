{
  "Description": "Detects when an attacker modifies values of the Disk Cleanup Handler in the registry to achieve persistence.\nThe disk cleanup manager is part of the operating system. It displays the dialog box [â€¦]\nThe user has the option of enabling or disabling individual handlers by selecting or clearing their check box in the disk cleanup manager's UI.\nAlthough Windows comes with a number of disk cleanup handlers, they aren't designed to handle files produced by other applications.\nInstead, the disk cleanup manager is designed to be flexible and extensible by enabling any developer to implement and register their own disk cleanup handler.\nAny developer can extend the available disk cleanup services by implementing and registering a disk cleanup handler.\n\n\nAuthor: Nasreddine Bencherchali (Nextron Systems)\nSigma Repository: [GitHub](https://github.com/SigmaHQ/sigma)",
  "ID": "d4f4e0be-cf12-439f-9e25-4e2cdcf7df5a",
  "InsertDate": "2025-01-25T21:22:40Z",
  "LastUpdateDate": "2025-01-25T21:22:40Z",
  "Level": "medium",
  "Name": "Potential Persistence Via Disk Cleanup Handler - Registry",
  "Query": "sourcetype like 'windows-%' eql select * from _source_ where ((event_type = 'CreateKey' and target_object like '%\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\VolumeCaches\\%') and  not (target_object like '%\\Active Setup Temp Folders' or target_object like '%\\BranchCache' or target_object like '%\\Content Indexer Cleaner' or target_object like '%\\D3D Shader Cache' or target_object like '%\\Delivery Optimization Files' or target_object like '%\\Device Driver Packages' or target_object like '%\\Diagnostic Data Viewer database files' or target_object like '%\\Downloaded Program Files' or target_object like '%\\DownloadsFolder' or target_object like '%\\Feedback Hub Archive log files' or target_object like '%\\Internet Cache Files' or target_object like '%\\Language Pack' or target_object like '%\\Microsoft Office Temp Files' or target_object like '%\\Offline Pages Files' or target_object like '%\\Old ChkDsk Files' or target_object like '%\\Previous Installations' or target_object like '%\\Recycle Bin' or target_object like '%\\RetailDemo Offline Content' or target_object like '%\\Setup Log Files' or target_object like '%\\System error memory dump files' or target_object like '%\\System error minidump files' or target_object like '%\\Temporary Files' or target_object like '%\\Temporary Setup Files' or target_object like '%\\Temporary Sync Files' or target_object like '%\\Thumbnail Cache' or target_object like '%\\Update Cleanup' or target_object like '%\\Upgrade Discarded Files' or target_object like '%\\User file versions' or target_object like '%\\Windows Defender' or target_object like '%\\Windows Error Reporting Files' or target_object like '%\\Windows ESD installation files' or target_object like '%\\Windows Upgrade Log Files'))",
  "Tags": [
    "attack.persistence"
  ],
  "Version": "0.1"
}